<!DOCTYPE html>
<html>

<head>
    <title>Dead Pixel & Filter Test</title>
    <style>
        body {
            background: #1a1a2e;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            position: relative;
            width: 640px;
            height: 480px;
            background: #000;
            border: 2px solid #444;
            margin-bottom: 20px;
        }

        canvas,
        img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .slider-row label {
            width: 120px;
        }

        input[type="range"] {
            flex: 1;
        }

        .status {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            background: #ff4757;
        }

        .status.active {
            background: #2ed573;
        }
    </style>
</head>

<body>
    <h1>Dead Pixel Fix Testing Box v2</h1>

    <div class="container">
        <!-- Mock stream image -->
        <canvas id="mock-stream" width="640" height="480" style="display:none;"></canvas>
        <img id="stream" src="" style="visibility: visible;">
        <canvas id="processing-canvas" width="640" height="480" style="display:none;"></canvas>
    </div>

    <div id="gpu-status" class="status">ðŸš« Processing Off</div>

    <div class="controls">
        <div>
            <h3>Post-Processing</h3>
            <div class="slider-row">
                <input type="checkbox" id="pp-enable" onchange="togglePostProcessing()">
                <label for="pp-enable">Enable Enhancement</label>
            </div>
            <div class="slider-row">
                <label>Brightness</label>
                <input type="range" id="pp-brightness" min="80" max="400" value="100" oninput="updateFilters()">
                <span id="pp-brightness-val">100%</span>
            </div>
            <div class="slider-row">
                <label>Contrast</label>
                <input type="range" id="pp-contrast" min="80" max="400" value="100" oninput="updateFilters()">
                <span id="pp-contrast-val">100%</span>
            </div>
            <div class="slider-row">
                <label>Saturate</label>
                <input type="range" id="pp-saturate" min="80" max="400" value="100" oninput="updateFilters()">
                <span id="pp-saturate-val">100%</span>
            </div>
        </div>

        <div>
            <h3>Dead Pixel Fix</h3>
            <div class="slider-row">
                <input type="checkbox" id="pp-deadpixel" onchange="toggleDeadPixelFix()">
                <label for="pp-deadpixel">Dead Pixel Fix</label>
            </div>
            <div class="slider-row">
                <label>Threshold (0-1000)</label>
                <input type="range" id="pp-deadpixel-sens" min="0" max="1000" step="1" value="200"
                    oninput="updateDeadPixelSens()">
                <span id="pp-deadpixel-sens-val">200</span>
            </div>

            <h3>Temporal Smoothing</h3>
            <div class="slider-row">
                <input type="checkbox" id="pp-interpolation" onchange="toggleInterpolation()">
                <label for="pp-interpolation">Smooth Motion</label>
            </div>
            <div class="slider-row">
                <label>Persistence</label>
                <input type="range" id="pp-smoothing-weight" min="0" max="100" step="1" value="50"
                    oninput="updateSmoothingWeight()">
                <span id="pp-smoothing-weight-val">50%</span>
            </div>
        </div>
    </div>

    <script>
        const streamImg = document.getElementById('stream');
        const procCanvas = document.getElementById('processing-canvas');
        const procCtx = procCanvas.getContext('2d', { willReadFrequently: true });

        // Mock stream setup
        const mockCanvas = document.getElementById('mock-stream');
        const mockCtx = mockCanvas.getContext('2d');

        function updateMockStream() {
            // Dark gray background
            mockCtx.fillStyle = '#222';
            mockCtx.fillRect(0, 0, 640, 480);

            // Add a "dead pixel" cluster (2x2)
            mockCtx.fillStyle = '#fff';
            mockCtx.fillRect(300, 200, 2, 2);

            // Add a single bright pixel
            mockCtx.fillStyle = '#fff';
            mockCtx.fillRect(100, 100, 1, 1);

            streamImg.src = mockCanvas.toDataURL();
        }
        setInterval(updateMockStream, 100);

        let interpolationActive = false;
        let deadPixelFixActive = false;
        let lastFrameData = null;
        let smoothingWeight = 0.5;
        let deadPixelThreshold = 200;
        let processingActive = false;

        function updateFilters() {
            const stream = document.getElementById('stream');
            const canvas = document.getElementById('processing-canvas');
            const enabled = document.getElementById('pp-enable').checked;

            const brightness = document.getElementById('pp-brightness').value;
            const contrast = document.getElementById('pp-contrast').value;
            const saturate = document.getElementById('pp-saturate').value;

            const filterStr = enabled ? `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturate}%)` : 'none';
            stream.style.filter = filterStr;
            canvas.style.filter = filterStr;

            document.getElementById('pp-brightness-val').textContent = brightness + '%';
            document.getElementById('pp-contrast-val').textContent = contrast + '%';
            document.getElementById('pp-saturate-val').textContent = saturate + '%';
            console.log("Filters applied:", filterStr);
        }

        function togglePostProcessing() { updateFilters(); }
        function toggleInterpolation() { interpolationActive = document.getElementById('pp-interpolation').checked; startProcessingIfNeeded(); }
        function updateSmoothingWeight() {
            const val = parseInt(document.getElementById('pp-smoothing-weight').value);
            smoothingWeight = val / 100;
            document.getElementById('pp-smoothing-weight-val').textContent = val + '%';
        }
        function toggleDeadPixelFix() { deadPixelFixActive = document.getElementById('pp-deadpixel').checked; startProcessingIfNeeded(); }
        function updateDeadPixelSens() {
            deadPixelThreshold = parseInt(document.getElementById('pp-deadpixel-sens').value);
            document.getElementById('pp-deadpixel-sens-val').textContent = deadPixelThreshold;
        }

        function startProcessingIfNeeded() {
            if (!processingActive && (interpolationActive || deadPixelFixActive)) {
                processingActive = true;
                document.getElementById('gpu-status').textContent = 'âš¡ Processing Active';
                document.getElementById('gpu-status').classList.add('active');
                requestAnimationFrame(processFrame);
            }
        }

        function processFrame() {
            if (!interpolationActive && !deadPixelFixActive) {
                processingActive = false;
                procCanvas.style.display = 'none';
                streamImg.style.visibility = 'visible';
                document.getElementById('gpu-status').textContent = 'ðŸš« Processing Off';
                document.getElementById('gpu-status').classList.remove('active');
                lastFrameData = null;
                return;
            }

            if (streamImg.complete) {
                procCanvas.width = 640;
                procCanvas.height = 480;
                procCanvas.style.display = 'block';
                streamImg.style.visibility = 'hidden';

                procCtx.drawImage(streamImg, 0, 0);
                const imageData = procCtx.getImageData(0, 0, 640, 480);
                const data = imageData.data;
                const w = 640;
                const h = 480;

                if (deadPixelFixActive) {
                    const diffLimit = (deadPixelThreshold / 10); // 0 to 100

                    for (let y = 2; y < h - 2; y++) {
                        for (let x = 2; x < w - 2; x++) {
                            const i = (y * w + x) * 4;
                            const lum = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;

                            // Sample 4 cardinal neighbors 2 pixels away to jump over clusters
                            const iT = ((y - 2) * w + x) * 4;
                            const iB = ((y + 2) * w + x) * 4;
                            const iL = (y * w + (x - 2)) * 4;
                            const iR = (y * w + (x + 2)) * 4;

                            const lumT = data[iT] * 0.299 + data[iT + 1] * 0.587 + data[iT + 2] * 0.114;
                            const lumB = data[iB] * 0.299 + data[iB + 1] * 0.587 + data[iB + 2] * 0.114;
                            const lumL = data[iL] * 0.299 + data[iL + 1] * 0.587 + data[iL + 2] * 0.114;
                            const lumR = data[iR] * 0.299 + data[iR + 1] * 0.587 + data[iR + 2] * 0.114;

                            const avgNeighbor = (lumT + lumB + lumL + lumR) / 4;

                            if (lum - avgNeighbor > diffLimit) {
                                data[i] = (data[iT] + data[iB] + data[iL] + data[iR]) / 4;
                                data[i + 1] = (data[iT + 1] + data[iB + 1] + data[iL + 1] + data[iR + 1]) / 4;
                                data[i + 2] = (data[iT + 2] + data[iB + 2] + data[iL + 2] + data[iR + 2]) / 4;
                            }
                        }
                    }
                }

                if (interpolationActive && lastFrameData) {
                    const alpha = 1.0 - smoothingWeight;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] * alpha + lastFrameData[i] * smoothingWeight;
                        data[i + 1] = data[i + 1] * alpha + lastFrameData[i + 1] * smoothingWeight;
                        data[i + 2] = data[i + 2] * alpha + lastFrameData[i + 2] * smoothingWeight;
                    }
                }

                lastFrameData = interpolationActive ? new Uint8ClampedArray(data) : null;
                procCtx.putImageData(imageData, 0, 0);
            }
            requestAnimationFrame(processFrame);
        }
    </script>
</body>

</html>